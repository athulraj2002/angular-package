import { HttpClient, HttpHeaders, HttpParams } from '@angular/common/http';
import { Inject, Injectable, isDevMode } from '@angular/core';
import { IsArray, IsString } from '../pop-common-utility';
import { PopBusiness } from '../pop-common.model';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export class PopRequestService {
    constructor(http, env) {
        this.http = http;
        this.env = env;
        this.offsetLimit = 2000;
        // if( +this.env.offsetLimit ) this.offsetLimit = this.env.offsetLimit;
        if (!this.baseUrl) {
            const envUrl = isDevMode() && this.env && this.env.apiBaseUrl ? this.env.apiBaseUrl : null;
            this.baseUrl = (envUrl ? envUrl : `${window.location.protocol}//api.${window.location.host}`);
        }
    }
    getHeaders(version, businessId = 0) {
        return {
            'X-Popcx-Business': +businessId ? String(businessId) : PopBusiness ? String(PopBusiness.id) : String(0),
            'Content-Type': 'application/json',
            'Api-Version': (typeof version !== 'undefined' ? version : 1).toString()
        };
    }
    getBaseUrl() {
        return this.baseUrl.slice();
    }
    setBaseUrl(baseUrl) {
        if (IsString(baseUrl, true)) {
            this.baseUrl = baseUrl;
        }
    }
    getOffsetLimit() {
        return this.offsetLimit;
    }
    doGet(url, params = {}, version = 1, ignore401 = false, businessId = 0) {
        const options = {
            headers: new HttpHeaders(this.getHeaders(version, businessId)),
            params: this._setParams(params)
        };
        if (ignore401)
            options.headers.set('SkipResponse401Interceptor', '1');
        if (url[0] !== '/')
            url = `/${url}`;
        return this.http.get(`${this.getBaseUrl()}${url}`, options);
    }
    doDelete(url, body = null, version = 1, ignore401 = null, businessId = 0) {
        const options = {
            headers: new HttpHeaders(this.getHeaders(version, businessId)),
            body: body,
        };
        if (ignore401)
            options.headers.set('SkipResponse401Interceptor', '1');
        if (url[0] !== '/')
            url = `/${url}`;
        // if( data ) options.params = new HttpParams(data);
        return this.http.delete(`${this.getBaseUrl()}${url}`, options);
    }
    doPatch(url, data, version = 1, ignore401 = false, businessId = 0) {
        const headers = new HttpHeaders(this.getHeaders(version, businessId));
        if (ignore401)
            headers.set('SkipResponse401Interceptor', '1');
        if (url[0] !== '/')
            url = `/${url}`;
        return this.http.patch(this.getBaseUrl() + url, JSON.stringify(data), { headers: headers });
    }
    doPost(url, data, version = 1, ignore401 = false, businessId = 0) {
        const headers = new HttpHeaders(this.getHeaders(version, businessId));
        if (ignore401)
            headers.set('SkipResponse401Interceptor', '1');
        if (url[0] !== '/')
            url = `/${url}`;
        return this.http.post(`${this.getBaseUrl()}${url}`, JSON.stringify(data), { headers: headers });
    }
    transform(value, transformation) {
        if (IsArray(transformation, true)) {
            transformation.map((transKey) => {
                // value = this.commonRepo.transform(value, transKey);
            });
        }
        else if (IsString(transformation, true)) {
            // value = this.commonRepo.transform(value, transformation);
        }
        return value;
    }
    _setParams(body) {
        let params = new HttpParams();
        for (const key of Object.keys(body)) {
            if (body[key]) {
                if (body[key] instanceof Array) {
                    body[key].forEach((item) => {
                        params = params.append(`${key.toString()}[]`, item);
                    });
                }
                else {
                    params = params.append(key.toString(), body[key]);
                }
            }
        }
        return params;
    }
}
PopRequestService.ɵprov = i0.ɵɵdefineInjectable({ factory: function PopRequestService_Factory() { return new PopRequestService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject("env")); }, token: PopRequestService, providedIn: "root" });
PopRequestService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
PopRequestService.ctorParameters = () => [
    { type: HttpClient },
    { type: undefined, decorators: [{ type: Inject, args: ['env',] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wLXJlcXVlc3Quc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3BvcC1jb21tb24vc3JjL2xpYi9zZXJ2aWNlcy9wb3AtcmVxdWVzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzNFLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU5RCxPQUFPLEVBQXNCLE9BQU8sRUFBWSxRQUFRLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN4RixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7OztBQU1sRCxNQUFNLE9BQU8saUJBQWlCO0lBTTVCLFlBQ1UsSUFBZ0IsRUFDRCxHQUFJO1FBRG5CLFNBQUksR0FBSixJQUFJLENBQVk7UUFDRCxRQUFHLEdBQUgsR0FBRyxDQUFDO1FBTlosZ0JBQVcsR0FBRyxJQUFJLENBQUM7UUFRbEMsdUVBQXVFO1FBQ3ZFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2pCLE1BQU0sTUFBTSxHQUFHLFNBQVMsRUFBRSxJQUFJLElBQUksQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDM0YsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUyxTQUFVLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSyxFQUFFLENBQUUsQ0FBQztTQUNyRztJQUNILENBQUM7SUFHTSxVQUFVLENBQUMsT0FBTyxF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QUMsY0FBYyxFQUFFLElBQUksQ0FBQyxFQUFFO1lBQ3hDLDREQUE0RDtTQUM3RDtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUdPLFVBQVUsQ0FBQyxJQUFJO1FBQ3JCLElBQUksTUFBTSxHQUFlLElBQUksVUFBVSxFQUFFLENBQUM7UUFDMUMsS0FBSyxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ25DLElBQUksSUFBSSxDQUFFLEdBQUcsQ0FBRSxFQUFFO2dCQUNmLElBQUksSUFBSSxDQUFFLEdBQUcsQ0FBRSxZQUFZLEtBQUssRUFBRTtvQkFDaEMsSUFBSSxDQUFFLEdBQUcsQ0FBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO3dCQUMzQixNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUN0RCxDQUFDLENBQUMsQ0FBQztpQkFDSjtxQkFBSTtvQkFDSCxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEVBQUUsSUFBSSxDQUFFLEdBQUcsQ0FBRSxDQUFDLENBQUM7aUJBQ3JEO2FBQ0Y7U0FDRjtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7Ozs7WUFsSEYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7WUFUUSxVQUFVOzRDQWtCZCxNQUFNLFNBQUMsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzLCBIdHRwUGFyYW1zIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBpc0Rldk1vZGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IENvbnZlcnRPYmplY3RUb1VyaSwgSXNBcnJheSwgSXNPYmplY3QsIElzU3RyaW5nIH0gZnJvbSAnLi4vcG9wLWNvbW1vbi11dGlsaXR5JztcbmltcG9ydCB7IFBvcEJ1c2luZXNzIH0gZnJvbSAnLi4vcG9wLWNvbW1vbi5tb2RlbCc7XG5cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgUG9wUmVxdWVzdFNlcnZpY2Uge1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgb2Zmc2V0TGltaXQgPSAyMDAwO1xuICBwcml2YXRlIGJhc2VVcmw6IHN0cmluZztcblxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcbiAgICBASW5qZWN0KCdlbnYnKSBwcml2YXRlIGVudj8sXG4gICl7XG4gICAgLy8gaWYoICt0aGlzLmVudi5vZmZzZXRMaW1pdCApIHRoaXMub2Zmc2V0TGltaXQgPSB0aGlzLmVudi5vZmZzZXRMaW1pdDtcbiAgICBpZiggIXRoaXMuYmFzZVVybCApe1xuICAgICAgY29uc3QgZW52VXJsID0gaXNEZXZNb2RlKCkgJiYgdGhpcy5lbnYgJiYgdGhpcy5lbnYuYXBpQmFzZVVybCA/IHRoaXMuZW52LmFwaUJhc2VVcmwgOiBudWxsO1xuICAgICAgdGhpcy5iYXNlVXJsID0gKCBlbnZVcmwgPyBlbnZVcmwgOiBgJHsgd2luZG93LmxvY2F0aW9uLnByb3RvY29sIH0vL2FwaS4keyB3aW5kb3cubG9jYXRpb24uaG9zdCB9YCApO1xuICAgIH1cbiAgfVxuXG5cbiAgcHVibGljIGdldEhlYWRlcnModmVyc2lvbiwgYnVzaW5lc3NJZCA9IDApe1xuICAgIHJldHVybiB7XG4gICAgICAnWC1Qb3BjeC1CdXNpbmVzcyc6ICtidXNpbmVzc0lkID8gU3RyaW5nKGJ1c2luZXNzSWQpOiBQb3BCdXNpbmVzcyA/IFN0cmluZyhQb3BCdXNpbmVzcy5pZCkgOiBTdHJpbmcoMCksXG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgJ0FwaS1WZXJzaW9uJzogKCB0eXBlb2YgdmVyc2lvbiAhPT0gJ3VuZGVmaW5lZCcgPyB2ZXJzaW9uIDogMSApLnRvU3RyaW5nKClcbiAgICB9O1xuICB9XG5cblxuICBwdWJsaWMgZ2V0QmFzZVVybCgpe1xuICAgIHJldHVybiB0aGlzLmJhc2VVcmwuc2xpY2UoKTtcbiAgfVxuXG5cbiAgcHVibGljIHNldEJhc2VVcmwoYmFzZVVybDogc3RyaW5nKTogdm9pZHtcbiAgICBpZiggSXNTdHJpbmcoYmFzZVVybCwgdHJ1ZSkgKXtcbiAgICAgIHRoaXMuYmFzZVVybCA9IGJhc2VVcmw7XG4gICAgfVxuICB9XG5cblxuICBwdWJsaWMgZ2V0T2Zmc2V0TGltaXQoKXtcbiAgICByZXR1cm4gdGhpcy5vZmZzZXRMaW1pdDtcbiAgfVxuXG5cbiAgZG9HZXQodXJsOiBzdHJpbmcsIHBhcmFtczogb2JqZWN0ID0ge30sIHZlcnNpb246IG51bWJlciA9IDEsIGlnbm9yZTQwMTogYm9vbGVhbiA9IGZhbHNlLCBidXNpbmVzc0lkID0gMCk6IE9ic2VydmFibGU8YW55PntcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHRoaXMuZ2V0SGVhZGVycyh2ZXJzaW9uLCBidXNpbmVzc0lkKSksXG4gICAgICBwYXJhbXM6IHRoaXMuX3NldFBhcmFtcyhwYXJhbXMpXG4gICAgfTtcbiAgICBpZiggaWdub3JlNDAxICkgb3B0aW9ucy5oZWFkZXJzLnNldCgnU2tpcFJlc3BvbnNlNDAxSW50ZXJjZXB0b3InLCAnMScpO1xuXG4gICAgaWYoIHVybFsgMCBdICE9PSAnLycgKSB1cmwgPSBgLyR7dXJsfWA7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLmdldDxhbnk+KGAkeyB0aGlzLmdldEJhc2VVcmwoKSB9JHsgdXJsIH1gLCBvcHRpb25zKTtcbiAgfVxuXG5cbiAgZG9EZWxldGUodXJsOiBzdHJpbmcsIGJvZHk6IG9iamVjdCA9IG51bGwsIHZlcnNpb246IG51bWJlciA9IDEsIGlnbm9yZTQwMTogYm9vbGVhbiA9IG51bGwsIGJ1c2luZXNzSWQgPSAwKTogT2JzZXJ2YWJsZTxhbnk+e1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnModGhpcy5nZXRIZWFkZXJzKHZlcnNpb24sIGJ1c2luZXNzSWQpKSxcbiAgICAgIGJvZHk6IGJvZHksXG4gICAgfTtcbiAgICBpZiggaWdub3JlNDAxICkgb3B0aW9ucy5oZWFkZXJzLnNldCgnU2tpcFJlc3BvbnNlNDAxSW50ZXJjZXB0b3InLCAnMScpO1xuICAgIGlmKCB1cmxbIDAgXSAhPT0gJy8nICkgdXJsID0gYC8ke3VybH1gO1xuICAgIC8vIGlmKCBkYXRhICkgb3B0aW9ucy5wYXJhbXMgPSBuZXcgSHR0cFBhcmFtcyhkYXRhKTtcbiAgICByZXR1cm4gdGhpcy5odHRwLmRlbGV0ZTxhbnk+KGAkeyB0aGlzLmdldEJhc2VVcmwoKSB9JHsgdXJsIH1gLCBvcHRpb25zKTtcbiAgfVxuXG5cbiAgZG9QYXRjaCh1cmw6IHN0cmluZywgZGF0YTogb2JqZWN0LCB2ZXJzaW9uOiBudW1iZXIgPSAxLCBpZ25vcmU0MDE6IGJvb2xlYW4gPSBmYWxzZSwgYnVzaW5lc3NJZCA9IDApOiBPYnNlcnZhYmxlPGFueT57XG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh0aGlzLmdldEhlYWRlcnModmVyc2lvbiwgYnVzaW5lc3NJZCkpO1xuICAgIGlmKCBpZ25vcmU0MDEgKSBoZWFkZXJzLnNldCgnU2tpcFJlc3BvbnNlNDAxSW50ZXJjZXB0b3InLCAnMScpO1xuICAgIGlmKCB1cmxbIDAgXSAhPT0gJy8nICkgdXJsID0gYC8ke3VybH1gO1xuICAgIHJldHVybiB0aGlzLmh0dHAucGF0Y2godGhpcy5nZXRCYXNlVXJsKCkgKyB1cmwsIEpTT04uc3RyaW5naWZ5KGRhdGEpLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gIH1cblxuXG4gIGRvUG9zdCh1cmw6IHN0cmluZywgZGF0YTogb2JqZWN0LCB2ZXJzaW9uOiBudW1iZXIgPSAxLCBpZ25vcmU0MDE6IGJvb2xlYW4gPSBmYWxzZSwgYnVzaW5lc3NJZCA9IDApOiBPYnNlcnZhYmxlPGFueT57XG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh0aGlzLmdldEhlYWRlcnModmVyc2lvbiwgYnVzaW5lc3NJZCkpO1xuICAgIGlmKCBpZ25vcmU0MDEgKSBoZWFkZXJzLnNldCgnU2tpcFJlc3BvbnNlNDAxSW50ZXJjZXB0b3InLCAnMScpO1xuICAgIGlmKCB1cmxbIDAgXSAhPT0gJy8nICkgdXJsID0gYC8ke3VybH1gO1xuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdDxhbnk+KGAkeyB0aGlzLmdldEJhc2VVcmwoKSB9JHsgdXJsIH1gLCBKU09OLnN0cmluZ2lmeShkYXRhKSwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICB9XG5cblxuICB0cmFuc2Zvcm0odmFsdWU6IHN0cmluZyB8IG51bWJlciwgdHJhbnNmb3JtYXRpb246IGFueSl7XG4gICAgaWYoIElzQXJyYXkodHJhbnNmb3JtYXRpb24sIHRydWUpICl7XG4gICAgICB0cmFuc2Zvcm1hdGlvbi5tYXAoKHRyYW5zS2V5KSA9PiB7XG4gICAgICAgIC8vIHZhbHVlID0gdGhpcy5jb21tb25SZXBvLnRyYW5zZm9ybSh2YWx1ZSwgdHJhbnNLZXkpO1xuICAgICAgfSk7XG4gICAgfWVsc2UgaWYoIElzU3RyaW5nKHRyYW5zZm9ybWF0aW9uLCB0cnVlKSApe1xuICAgICAgLy8gdmFsdWUgPSB0aGlzLmNvbW1vblJlcG8udHJhbnNmb3JtKHZhbHVlLCB0cmFuc2Zvcm1hdGlvbik7XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG5cbiAgcHJpdmF0ZSBfc2V0UGFyYW1zKGJvZHkpe1xuICAgIGxldCBwYXJhbXM6IEh0dHBQYXJhbXMgPSBuZXcgSHR0cFBhcmFtcygpO1xuICAgIGZvciggY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGJvZHkpICl7XG4gICAgICBpZiggYm9keVsga2V5IF0gKXtcbiAgICAgICAgaWYoIGJvZHlbIGtleSBdIGluc3RhbmNlb2YgQXJyYXkgKXtcbiAgICAgICAgICBib2R5WyBrZXkgXS5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMuYXBwZW5kKGAke2tleS50b1N0cmluZygpfVtdYCwgaXRlbSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcy5hcHBlbmQoa2V5LnRvU3RyaW5nKCksIGJvZHlbIGtleSBdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGFyYW1zO1xuICB9XG59XG5cbiJdfQ==